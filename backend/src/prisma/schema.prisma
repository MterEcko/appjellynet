// StreamQbit Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== USERS & ACCOUNTS =====

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  passwordHash          String    @map("password_hash")
  plan                  Plan      @default(BASIC)
  accountType           AccountType @map("account_type") @default(MONTHLY)
  status                AccountStatus @default(ACTIVE)

  // WISP specific
  wispCustomerId        String?   @unique @map("wisp_customer_id")

  // Demo specific
  demoExpiresAt         DateTime? @map("demo_expires_at")
  demoDurationDays      Int?      @map("demo_duration_days")

  // Payment
  stripeCustomerId      String?   @unique @map("stripe_customer_id")
  mercadopagoCustomerId String?   @unique @map("mercadopago_customer_id")

  // Suspension
  suspendedAt           DateTime? @map("suspended_at")
  suspensionReason      String?   @map("suspension_reason")

  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  lastLogin             DateTime? @map("last_login")

  // Relations
  profiles              Profile[]
  subscriptions         Subscription[]
  paymentMethods        PaymentMethod[]
  watchHistory          WatchHistory[]
  auditLogs             AuditLog[]

  @@map("users")
}

model Profile {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  jellyfinUserId    String   @unique @map("jellyfin_user_id")
  name              String
  avatar            String?
  pin               String?
  ageRestriction    Int      @default(18) @map("age_restriction")
  language          String   @default("es")
  subtitleLanguage  String?  @map("subtitle_language")
  qualityPreference String?  @map("quality_preference")
  isPrimary         Boolean  @default(false) @map("is_primary")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

// ===== JELLYFIN SERVERS =====

model Server {
  id            String       @id @default(uuid())
  serverId      String       @unique @map("server_id")
  name          String
  url           String
  networkCidr   String?      @map("network_cidr")
  priority      Int          @default(1)
  protocol      Protocol     @default(HTTP)
  isFallback    Boolean      @default(false) @map("is_fallback")
  isActive      Boolean      @default(true) @map("is_active")

  lastHealthCheck DateTime?  @map("last_health_check")
  latencyMs       Int?       @map("latency_ms")

  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  @@map("servers")
}

// ===== ADVERTISING =====

model Ad {
  id            String      @id @default(uuid())
  type          AdType
  campaignName  String      @map("campaign_name")
  filePath      String      @map("file_path")
  fileUrl       String      @map("file_url")
  duration      Int?        // En segundos, para videos
  weight        Int         @default(5)
  clickUrl      String?     @map("click_url")

  startDate     DateTime    @map("start_date")
  endDate       DateTime    @map("end_date")
  active        Boolean     @default(true)

  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  views         AdView[]

  @@map("ads")
}

model AdView {
  id                String      @id @default(uuid())
  adId              String      @map("ad_id")
  userId            String      @map("user_id")
  profileId         String?     @map("profile_id")
  itemId            String      @map("item_id") // Jellyfin item ID

  event             AdEvent
  position          String?     // preroll, midroll-1, midroll-2, pauseroll

  createdAt         DateTime    @default(now()) @map("created_at")

  ad                Ad          @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@map("ad_views")
  @@index([adId])
  @@index([userId])
  @@index([createdAt])
}

// ===== WATCH HISTORY =====

model WatchHistory {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  profileId             String   @map("profile_id")
  jellyfinItemId        String   @map("jellyfin_item_id")
  jellyfinItemType      String   @map("jellyfin_item_type")
  title                 String

  watchedAt             DateTime @map("watched_at")
  progressTicks         BigInt   @map("progress_ticks")
  durationTicks         BigInt   @map("duration_ticks")
  completed             Boolean  @default(false)

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("watch_history")
  @@index([userId])
  @@index([profileId])
}

// ===== SUBSCRIPTIONS & PAYMENTS =====

model Subscription {
  id                    String            @id @default(uuid())
  userId                String            @map("user_id")
  provider              PaymentProvider
  externalId            String            @map("external_id") // Stripe subscription ID

  status                SubscriptionStatus
  currentPeriodStart    DateTime          @map("current_period_start")
  currentPeriodEnd      DateTime          @map("current_period_end")
  cancelAtPeriodEnd     Boolean           @default(false) @map("cancel_at_period_end")
  canceledAt            DateTime?         @map("canceled_at")

  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model PaymentMethod {
  id                String          @id @default(uuid())
  userId            String          @map("user_id")
  provider          PaymentProvider
  externalId        String          @map("external_id")

  type              String          // card, bank_account, etc
  last4             String?
  brand             String?
  expiryMonth       Int?            @map("expiry_month")
  expiryYear        Int?            @map("expiry_year")

  isDefault         Boolean         @default(false) @map("is_default")

  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

// ===== WEBHOOKS =====

model Webhook {
  id            String          @id @default(uuid())
  name          String
  url           String
  events        String[]        // Array of event names
  secret        String
  active        Boolean         @default(true)
  headers       Json?           // Custom headers

  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  deliveries    WebhookDelivery[]

  @@map("webhooks")
}

model WebhookDelivery {
  id            String          @id @default(uuid())
  webhookId     String          @map("webhook_id")
  event         String
  payload       Json
  response      Json?
  statusCode    Int?            @map("status_code")
  success       Boolean         @default(false)
  attempts      Int             @default(0)

  createdAt     DateTime        @default(now()) @map("created_at")
  deliveredAt   DateTime?       @map("delivered_at")

  webhook       Webhook         @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("webhook_deliveries")
  @@index([webhookId])
  @@index([createdAt])
}

// ===== API KEYS =====

model ApiKey {
  id            String   @id @default(uuid())
  name          String
  key           String   @unique
  permissions   String[] // Array of permissions
  active        Boolean  @default(true)
  lastUsed      DateTime? @map("last_used")

  createdAt     DateTime @default(now()) @map("created_at")
  expiresAt     DateTime? @map("expires_at")

  @@map("api_keys")
}

// ===== AUDIT LOG =====

model AuditLog {
  id            String   @id @default(uuid())
  userId        String?  @map("user_id")
  action        String
  entity        String
  entityId      String?  @map("entity_id")
  changes       Json?
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")

  createdAt     DateTime @default(now()) @map("created_at")

  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
  @@index([userId])
  @@index([createdAt])
}

// ===== ENUMS =====

enum Plan {
  BASIC
  PREMIUM
  DEMO
}

enum AccountType {
  WISP
  DEMO
  MONTHLY
  WEEKLY
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  PENDING
  GRACE_PERIOD
}

enum Protocol {
  HTTP
  HTTPS
}

enum AdType {
  PREROLL
  MIDROLL
  PAUSEROLL
}

enum AdEvent {
  IMPRESSION
  STARTED
  COMPLETED
  SKIPPED
  CLICKED
}

enum PaymentProvider {
  STRIPE
  MERCADOPAGO
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  INCOMPLETE
  TRIALING
}
